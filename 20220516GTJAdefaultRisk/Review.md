# 国泰君安发债企业违约风险预测竞赛
# 回顾总结
## 一、前言
2022年5月12日完成招商银行数据竞赛后，晚上注意到国泰君安发债企业违约风险预测竞赛还可以报名，但是距离5月16日初赛截止只有4天。但是考虑到这个竞赛和金融行业高度相关，还是决定参与一下。

因为时间紧张，这个竞赛提供的数据集含有多张表，且涵盖财务指标、违约记录、新闻汇总等多类信息，不同信息需要提取的指标、需要做的预处理操作都不同。而且需要自行从数据中构建训练集和测试集。因此直到5月16日才完成了baseline。依旧是多亏了特征工程，线下AUC0.7，但线上AUC达到0.835.官方提供的开源baseline过拟合严重，线下0.9但线上只有0.7。因此初步完成的baseline还是要优于官方提供的开源baseline的。
## 二、赛题描述
自2014年我国债券市场“刚性兑付”神话被打破后，债券违约现象日益升温，2018年债券市场有160只债券发生违约，涉及44家发债企业，违约余额高达1505.25亿元，违约严重程度达历史之最。在债券市场信用风险加速暴露、违约事件发生趋于常态化的背景下，如何对发债企业违约风险进行有效评估与提前预测成为当前面临的重要监管难题。由于信息不完全，单纯依靠财务数据已难以充分解释违约风险溢价问题。如何有效利用财务以外的其他数据，例如发债企业的舆情数据、股权上下游数据，对发债企业违约风险进行预测具有重要意义。

本赛题任务是利用机器学习、深度学习等方法训练一个预测模型，该模型可以学习发债企业的相关信息，以预测发债企业未来一段时间内是否存在违约风险。赛题的难点在于数据集中包括大量的发债企业相关信息（股东信息、对外投资信息以及舆情信息等等），如何从中提取有效的特征并进行风险预测成为本赛题的关键问题。
## 三、竞赛记录
本次竞赛只完成了baseline版本。

**日期	操作	模型性能变化AUC**
2022/5/16	数据预处理、选取特征、构建训练集	SVM线上0.875

## 四、总体思路
通过本次竞赛，我进行了一系列的数据检查与预处理、数据探索性分析、手动&自动的特征工程、模型选择与调参、线上验证与精细化调整等历程。总结本次参与竞赛的思路如下：
### 1.数据检查和预处理
数据检查和预处理阶段一般是对数据的空值率、重复率进行检查，并确定空值数据的填充方式和重复数据的删除。

国泰君安竞赛针对提供的数据集提供了较为详细的说明，本竞赛提供的数据集没有显性的空值，但存在较多的数据重复。而且不同表里的企业范围不完全一致，有些企业不存在财务指标，有些企业则不存在新闻舆情数据，有些企业不存在历史违约信息等，这些都是隐性的空值。不同表的信息需要抽取出相应的指标挂接到总表企业id上，而对于不同表挂接中产生的空值有着不同的处理方式：

（1）基本信息表中ent_id为主键，因此ent_id重复即可判定为重复记录删除；为以防万一，ent_id重复的记录经检查其他字段值也完全相同；

（2）财务指标表汇聚了各企业3年12个季度报告期的财务指标数据，因此ent_id和报告期构成联合主键。但经检查，存在记录具备相同的id和报告期，但是指标值不同。因为矛盾的数据记录只有3条，直接删除了。

（3）新闻舆情表中同样也有许多各字段完全重复的数据，直接删了。newscode为唯一标识，有一部分newscode和entid相同，但是index或title或者impscore不同（实质上还是同一个新闻）。如果新闻标题不同，但风险标签一致，则认为可删除；如果风险标签（index和indextype）不一致，认为这个新闻同时反映了不同的风险（index分类未公开），需要同时保留.

（4）违约信息表记录了企业在过去3年的违约记录，不存在唯一标识字段，只删除全部字段值相同的记录。

（5）基于企业违约风险评级的理论模型，从经营风险、财务风险、潜在政府支持和其他风险指标四方面选择纳入模型的特征。其中经营风险包括行业状况、企业特征、经营效率三方面，财务风险则包括盈利能力、偿债能力、资本结构、财务弹性四方面，潜在政府支持则由地区营商环境、是否为国企两指标构成。其他风险指标包括各类型各等级负面新闻数量和历史违约记录两方面。将这些指标构建并挂接至总表时，部分企业不存在相应数据，产生空值。因为同一行业内企业的相似性更高，而利润率、资产负债率、资产周转率等比率型财务指标和经营效率指标一般在同行业内服从正态分布，因此这些指标为空的企业，可以依据其所在的行业填充为该行业的平均值。但对于新闻数量、违约记录等空值则应该填充为0。

（6）提供的数据集并没有分为训练集和测试集，需要自行划分。因为仅提供了3年数据用于预测下一年违约概率，出于训练集与测试集的时间跨度应该相等，因此不可能将3年跨度的数据同时输入模型。因此有两种划分方案：

一是以一年数据为特征，用下一年是否违约构建label。最终仅使2020年数据预测2021年风险。训练样本多，但不考虑多年数据可能会有损性能。此外2019年违约风险和2021年违约风险是否同分布是要打问号的，即使用2018年数据预测2019年风险，2019年数据预测2020年风险，训练集内部本身可能就不是同分布的，训练集和测试集不是同分布的概率会更大。

二是以两年数据为特征，下一年是否违约构建label。因为总共就3年数据，所以样本数量仅为一年情况下的一半。多考虑一年数据或许有助于提高模型准度。
综合考虑之下，采用了两年数据构建训练集和测试集的方案。

### 2.数据探索性分析
在经过数据预处理后，得到无空值无重复的样本特征数据。进行数据探索性分析的目的是查看各特征数据的分布、不同标签分类下特征数据分布的差异。

从理论层面分析，财务指标等比率数据一般在行业内是正态分布的，而经营时间、历史违约次数、新闻数量等在行业内一般为对数正态分布的，因此不同指标有些需要进行对数变换，有些只需要进行标准化。但相同的是这些数学变换一般都是在行业尺度上开展的，而不是全体样本尺度上开展的。

在本竞赛中并未通过频率直方图、概率密度图等检查数据分布，也并未检查特征的相关性。实际上后续模型性能的变化表明，财务指标比率数据可能存在质量上的问题，导致出现太多的奇异值，而我省略了探索性分析步骤并未发现这个问题。还是有必要在特征工程前对特征进行仔细的探索分析的。

### 3.特征工程
特征工程部分，我将其分为特征变换、特征构造和特征评价三部分。

#### (1)特征变换
特征变换是指，依据数据探索性分析的结果，对特征数据进行数学变换。主要包括连续变量的对数化和标准化、分类变量的数值化。

在国泰君安的比赛中，我对大部分连续变量字段进行了行业尺度下的对数处理和标准化处理。其中的代码实现难点在于先筛选出行业，在计算并修改该行业各特征的值。因为最近刚熟悉pandas，实现上出现了多次赋值bug，多花了些时间。

而对于分类字段的数值化，国泰君安的比赛我对企业所属的行业进行了二值化处理，重资产重周转行业为1，其他行业为0.因为我认为从理论上重资产行业负债率要高于轻资产行业，因此在违约风险上具备着不同的分布。而企业的性质按照是否为国企、是否为上市企业进行了二值化处理，这两个字段很明显体现了企业的抗风险能力。企业所处的地区则用于构建企业的营商环境指标，使用了频率进行数值化，在随机抽样的假设下，如果一个地区企业多，那这个地区的营商环境和商业实力要更强一些，企业的抗风险能力也更高一些。
#### (2)特征评价
通过对已有的特征进行评分，发现高分离度的特征为历史违约次数和不同风险等级、不同风险类型的新闻数量。而传统我们认为应该对违约风险有重要指示意义的财务指标中，只有年化净资产收益率上榜。大部分财务指标的分离度都不高。
#### (3)特征构造
因为初始特征的构造就是基于理论逻辑筛选的，所以额外特征的构造则是通过数学方法暴力构造的。但是可能是因为数据质量问题，原数据各类财务指标中存在大量奇异值，比如存在成千上万量级的净利润率。所以即便数据经过了标准化，依旧存在较多的问题。以这些基础特征构造出的新特征效果也不佳。
### 4.数据模型与参数设置
因为与招商银行比赛仅间隔几天，没有学习新模型，依旧使用的SVM和ANN。将依据理论构建的全部特征输入至模型时，其中可能是因为上一节提到的奇异值问题，ANN模型效果比较差，只有0.38.而SVM因为对量级不同一的问题容忍度更高，效果较好，AUC为0.68.

将特征精简为高分离度的特征时，SVM模型AUC提高至0.78左右，线上验证为0.835.

**事实证明构建的特征评分指标确实是有用的，高分离度指标一般可以提高模型表现**。但前提是特征经标准化处理后近似服从标准正态分布，如果原数据存在质量问题，比如这个里面的财务指标数据，哪怕构建出分离度更高的新特征，也不一定能够提高模型性能。这次使用的高分离度指标都是新闻数据和历史违约数据，不存在质量问题，分离度指标也很好的衡量了特征的信息量。
### 5.模型线上验证与调整
这一阶段没什么好说的，主要工作是：通过线下AUC与线上AUC对比，判断是否存在过拟合；如果存在过拟合，则需要开展精细化的特征筛选、对抗验证等。

本次因为竞赛时间比较赶，只简单做了特征的暴力构造，并依据线下AUC变化进行筛选。因为之前提到的财务指标数据问题，新构造出的指标有数百个分值高于1，但效果都很差。所以没什么改进。
## 五、总结
总结本次竞赛中数据预处理、特征工程等，主要有以下几点感悟和经验：
### 1.特征构建与选择的方法
**本次国泰君安竞赛使用的特征构建的思路与招商银行竞赛中特征工程的思路具有较大差异**。因为本次竞赛提供的原始数据都有清楚的说明，从而可以依据理论进行构建和筛选。

**本次债务违约风险的预测，采用了国内企业债务信用评级的框架。从经营风险、财务风险、潜在政策支持和其他指标数据四方面构建了模型的特征体系。同时采用特征评分的数学方法进行辅助筛选，最终初次训练的模型版本其性能便优于官方提供的开源baseline**。

而招商银行竞赛因为特征含义不明，特征构造与筛选完全通过数学方法实现。但也正是因为招商竞赛的经历，我才总结了一个简单好用的特征评价指标并用于基于理论构建的指标体系的进一步筛选，而不需要通过特征遍历检验AUC变化实现特征的筛选。

最终模型的性能表明，虽然这些特征具备理论基础，但似乎历史违约记录、负面新闻数量这种信息更综合的、市场预期与内部消息相混杂的指标更能起到违约风险预测作用。
### 2.行业尺度下的数据预处理
本次竞赛中，对各类财务指标、新闻舆情和违约记录等数据，都**在行业尺度下开展了对数变换和标准化**。我认为这个预处理的逻辑是正确的。**预处理后各指标理论上应服从标准正态分布，且消除了行业差异的影响从而具备跨行业的可比性**。比如如果某些企业某特征取值均小于0，那么无论这些企业分别属于哪些行业，都意味着这些企业的该特征在本行业里都属于下游水平，相对而言经营风险和财务风险更高一些。从而实现特征在不同违约风险主体间的分离。
### 3.关于财务指标的质量问题
本次选取的财务指标存在很多奇异值，如成千上万的利润率。其他未入选特征集的财务指标也有许多问题，比如总付息债务为0，但利息费用却为正值。但是基于比赛提供的数据集本身难以确定正确的值应该是什么。所以虽然怀疑数据质量存在问题，但暂时没想到如何能够解决这个问题。
### 4.关于模型性能提升
本次比赛提供的指标数据非常多，基于债务信用评级框架构建的特征集仅是非常小的一部分。因此把其他各类指标数据纳入进来，然后进行特征交叉相乘、升次降幂等理论上还能构建出大量的特征，模型性能还有较大提升空间，猜测榜单上评分极高的模型基本上都是首先进行特征理论筛选，然后进行数学上的暴力构造，再结合复杂的、可自动生成特征的模型进一步获取深层特征信息，最终得到极高的预测效果。但通过纯数学方法构建的特征往往没有明确业务意义。


